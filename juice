import React, { useState, useEffect, useRef } from 'react';
import { Timer, Zap, Calendar, Hammer, Info, RefreshCw, Clock } from 'lucide-react';

// Color Palette Constants
const COLORS = {
  orange: '#FF9F1C',
  yellow: '#FFBF00',
  lime: '#D4E157',
  red: '#FF6B6B', // For negative ROI
  offWhite: '#FDFBF7',
  textDark: '#4A3B32',
};

const App = () => {
  // --- State ---
  const [inputs, setInputs] = useState({
    frequency: 'daily', // daily, weekly, monthly
    durationVal: 52,
    durationUnit: 'weeks', // weeks, months, years
    manualTime: 30, // minutes
    aiTime: 5, // minutes
    buildTime: 4, // HOURS - New input
  });

  const [result, setResult] = useState(null);
  const [isAnimating, setIsAnimating] = useState(false);
  
  // --- Refs for confetti ---
  const confettiRef = useRef(null);

  // --- Load Confetti Script ---
  useEffect(() => {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js';
    script.async = true;
    document.body.appendChild(script);
    return () => {
      document.body.removeChild(script);
    };
  }, []);

  // --- Handlers ---
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setInputs(prev => ({
      ...prev,
      [name]: value
    }));
  };

  const triggerConfetti = () => {
    if (window.confetti) {
      window.confetti({
        particleCount: 150,
        spread: 80,
        origin: { y: 0.6 },
        colors: [COLORS.orange, COLORS.yellow, COLORS.lime, '#ffffff'],
        shapes: ['circle', 'square'], 
        scalar: 1.2
      });
    }
  };

  const calculateROI = () => {
    setIsAnimating(true);
    
    // 1. Calculate Occurrences per Week
    let instancesPerWeek = 0;
    if (inputs.frequency === 'daily') instancesPerWeek = 5; // Assuming work week
    if (inputs.frequency === 'weekly') instancesPerWeek = 1;
    if (inputs.frequency === 'monthly') instancesPerWeek = 0.23; // 12 / 52
    if (inputs.frequency === 'adhoc') instancesPerWeek = 0.1; 

    // 2. Calculate Total Lifespan in Weeks
    let totalWeeks = parseFloat(inputs.durationVal);
    if (inputs.durationUnit === 'months') totalWeeks = totalWeeks * 4.33;
    if (inputs.durationUnit === 'years') totalWeeks = totalWeeks * 52;

    // 3. Total Instances
    const totalInstances = instancesPerWeek * totalWeeks;

    // 4. Time Delta (Minutes)
    const manualMins = parseFloat(inputs.manualTime);
    const aiMins = parseFloat(inputs.aiTime);
    const timeSavedPerInstance = manualMins - aiMins;

    // 5. Gross Juice (Hours)
    const grossMinutesSaved = totalInstances * timeSavedPerInstance;
    const grossHoursSaved = grossMinutesSaved / 60;

    // 6. Net Juice (Hours) - NEW CALCULATION
    const buildHours = parseFloat(inputs.buildTime);
    const netHoursSaved = grossHoursSaved - buildHours;

    // Animation delay for dramatic effect
    setTimeout(() => {
      setResult({
        grossHours: grossHoursSaved.toFixed(1),
        buildHours: buildHours.toFixed(1),
        netHours: netHoursSaved.toFixed(1),
        isWorthIt: netHoursSaved > 0,
        instances: Math.ceil(totalInstances),
      });
      setIsAnimating(false);
      
      if (netHoursSaved > 0) {
        triggerConfetti();
      }
    }, 800);
  };

  // --- Helper to get emoji ---
  const getVerdictEmoji = () => {
    if (!result) return '';
    if (parseFloat(result.netHours) > 100) return 'ü§Ø'; // Massive win
    return result.isWorthIt ? 'üßÉ' : 'üçã';
  };

  return (
    <div className="min-h-screen font-sans selection:bg-orange-200" style={{ backgroundColor: COLORS.offWhite, color: COLORS.textDark, fontFamily: '"Nunito", "Poppins", sans-serif' }}>
      
      {/* Import Font */}
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&family=Poppins:wght@500;700&display=swap');
        
        .blob-btn {
          background: linear-gradient(135deg, ${COLORS.orange}, #F57C00);
          transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .blob-btn:active {
          transform: scale(0.95);
        }
        .bubble {
          position: absolute;
          background: rgba(255,255,255,0.3);
          border-radius: 50%;
        }
      `}</style>

      <div className="max-w-5xl mx-auto px-4 py-8 md:py-12">
        
        {/* Header */}
        <header className="text-center mb-10">
          <div className="inline-block bg-orange-100 rounded-full px-4 py-1 mb-4 border border-orange-200 shadow-sm">
            <span className="text-sm font-bold text-orange-600 tracking-wide uppercase">ROI Calculator 2.0</span>
          </div>
          <h1 className="text-4xl md:text-5xl font-extrabold mb-3 text-gray-900 leading-tight">
            Is the Juice <br className="md:hidden"/> Worth the Squeeze? üçä
          </h1>
          <p className="text-lg text-gray-600 max-w-xl mx-auto">
            Factor in your build time to see if automating that workflow is a net win or a time sink.
          </p>
        </header>

        <div className="grid lg:grid-cols-2 gap-8 items-start">
          
          {/* LEFT COLUMN: THE SQUEEZE (INPUTS) */}
          <div className="bg-white p-6 md:p-8 rounded-3xl shadow-xl border border-orange-100 relative overflow-hidden">
            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500"></div>
            
            <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
              <span className="bg-orange-100 p-2 rounded-lg text-xl">üõí</span> 
              The Ingredients
            </h2>

            <div className="space-y-6">
              
              {/* Frequency */}
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <RefreshCw size={16} className="text-orange-500"/> Task Frequency
                </label>
                <div className="relative">
                  <select 
                    name="frequency"
                    value={inputs.frequency}
                    onChange={handleInputChange}
                    className="w-full bg-gray-50 border-2 border-gray-200 text-gray-800 text-lg rounded-xl focus:ring-4 focus:ring-orange-100 focus:border-orange-400 block p-3 appearance-none cursor-pointer transition-all"
                  >
                    <option value="daily">Daily (Mon-Fri)</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="adhoc">Ad-hoc (Rarely)</option>
                  </select>
                </div>
              </div>

              {/* Duration */}
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <Calendar size={16} className="text-orange-500"/> Project Lifespan
                </label>
                <div className="flex gap-2">
                  <input 
                    type="number" 
                    name="durationVal"
                    value={inputs.durationVal}
                    onChange={handleInputChange}
                    className="w-1/3 bg-gray-50 border-2 border-gray-200 text-gray-800 text-lg rounded-xl focus:ring-4 focus:ring-orange-100 focus:border-orange-400 p-3 font-bold text-center"
                    placeholder="52"
                  />
                  <div className="relative w-2/3">
                    <select 
                      name="durationUnit"
                      value={inputs.durationUnit}
                      onChange={handleInputChange}
                      className="w-full bg-gray-50 border-2 border-gray-200 text-gray-800 text-lg rounded-xl focus:ring-4 focus:ring-orange-100 focus:border-orange-400 block p-3 appearance-none cursor-pointer"
                    >
                      <option value="weeks">Weeks</option>
                      <option value="months">Months</option>
                      <option value="years">Years</option>
                    </select>
                  </div>
                </div>
              </div>

              {/* Task Times */}
              <div className="grid grid-cols-2 gap-4">
                <div className="bg-red-50 p-4 rounded-2xl border border-red-100">
                  <label className="block text-xs font-bold text-red-800 uppercase mb-2">Old Way üê¢</label>
                  <div className="relative">
                    <input 
                      type="number" 
                      name="manualTime"
                      value={inputs.manualTime}
                      onChange={handleInputChange}
                      className="w-full bg-white border border-red-200 text-red-900 text-xl font-bold rounded-lg focus:ring-2 focus:ring-red-200 p-2 pr-12"
                    />
                    <span className="absolute right-3 top-3 text-red-300 text-sm font-bold">min</span>
                  </div>
                </div>

                <div className="bg-green-50 p-4 rounded-2xl border border-green-100">
                  <label className="block text-xs font-bold text-green-800 uppercase mb-2">New Way ü§ñ</label>
                  <div className="relative">
                    <input 
                      type="number" 
                      name="aiTime"
                      value={inputs.aiTime}
                      onChange={handleInputChange}
                      className="w-full bg-white border border-green-200 text-green-900 text-xl font-bold rounded-lg focus:ring-2 focus:ring-green-200 p-2 pr-12"
                    />
                    <span className="absolute right-3 top-3 text-green-300 text-sm font-bold">min</span>
                  </div>
                </div>
              </div>

              {/* Build Time Input (NEW) */}
              <div className="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                <label className="block text-sm font-bold text-blue-800 mb-2 flex items-center gap-2">
                  <Hammer size={16}/> Build Cost (Est. Dev Time)
                </label>
                <div className="relative">
                  <input 
                    type="number" 
                    name="buildTime"
                    value={inputs.buildTime}
                    onChange={handleInputChange}
                    className="w-full bg-white border border-blue-200 text-blue-900 text-xl font-bold rounded-lg focus:ring-2 focus:ring-blue-200 p-2 pr-12"
                  />
                  <span className="absolute right-3 top-3 text-blue-400 text-sm font-bold">hours</span>
                </div>
                <p className="text-xs text-blue-600 mt-2">How long will it take you to build/set this up?</p>
              </div>

              <button 
                onClick={calculateROI}
                disabled={isAnimating}
                className={`w-full blob-btn text-white text-xl font-bold py-4 rounded-xl shadow-lg shadow-orange-200 flex items-center justify-center gap-2 mt-4 hover:shadow-xl ${isAnimating ? 'opacity-80 cursor-wait' : ''}`}
              >
                {isAnimating ? (
                  <>Squeezing... üíß</>
                ) : (
                  <>Squeeze It! üßÉ</>
                )}
              </button>
            </div>
          </div>

          {/* RIGHT COLUMN: THE JUICE (OUTPUTS) */}
          <div className="relative min-h-[500px] h-full">
            {/* Empty State */}
            {!result && !isAnimating && (
              <div className="bg-white/50 border-2 border-dashed border-gray-300 rounded-3xl h-full flex flex-col items-center justify-center p-8 text-center min-h-[500px]">
                <div className="text-6xl mb-4 opacity-50">‚öñÔ∏è</div>
                <h3 className="text-xl font-bold text-gray-500">The ROI Verdict</h3>
                <p className="text-gray-400 mt-2">Will the build time eat all your savings?</p>
                <p className="text-gray-400">Calculate to find out.</p>
              </div>
            )}

            {/* Results View */}
            {(result || isAnimating) && (
               <div className="bg-white rounded-3xl shadow-xl overflow-hidden h-full flex flex-col relative border border-gray-100 min-h-[500px]">
                 
                 {/* Visual Cup Representation */}
                 <div className="flex-grow bg-gray-50 relative flex items-end justify-center p-8 min-h-[250px]">
                    {/* The Cup */}
                    <div className="relative w-36 h-52 border-4 border-gray-800 rounded-b-2xl bg-white/30 backdrop-blur-sm z-10 overflow-hidden shadow-2xl">
                      
                      {/* Measurement Lines */}
                      <div className="absolute top-1/4 w-full h-0.5 bg-gray-800/10"></div>
                      <div className="absolute top-2/4 w-full h-0.5 bg-gray-800/10"></div>
                      <div className="absolute top-3/4 w-full h-0.5 bg-gray-800/10"></div>

                      {/* The Liquid */}
                      <div 
                        className={`absolute bottom-0 left-0 w-full transition-all duration-1000 ease-out flex items-center justify-center ${isAnimating ? 'h-0' : ''}`}
                        style={{ 
                          height: result ? `${Math.min(Math.max((Math.abs(result.netHours) / 40) * 100, 15), 100)}%` : '0%',
                          backgroundColor: result?.netHours > 0 ? COLORS.orange : COLORS.red // Red if negative ROI
                        }}
                      >
                         {/* Bubbles */}
                         {!isAnimating && (
                           <>
                             <div className="bubble w-2 h-2 bottom-4 left-4 animate-bounce"></div>
                             <div className="bubble w-3 h-3 bottom-10 right-6 animate-bounce delay-75"></div>
                           </>
                         )}
                      </div>
                    </div>
                    
                    {/* Floating Emoji */}
                    <div className={`absolute top-8 text-7xl transition-all duration-500 transform ${result && !isAnimating ? 'scale-100 opacity-100 rotate-12' : 'scale-0 opacity-0'}`}>
                      {getVerdictEmoji()}
                    </div>
                 </div>

                 {/* Metrics Text */}
                 <div className="p-6 bg-white z-20 border-t border-gray-100">
                   {!isAnimating && result && (
                     <div className="text-center animate-fade-in-up">
                       
                       <h3 className="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Net ROI (Time Saved - Build Time)</h3>
                       <div className={`text-5xl font-black mb-2 ${result.netHours > 0 ? 'text-green-500' : 'text-red-500'}`}>
                         {result.netHours > 0 ? '+' : ''}{result.netHours} <span className="text-2xl font-bold text-gray-400">Hours</span>
                       </div>

                       {/* Verdict Badge */}
                       <div className={`py-2 px-4 rounded-lg inline-block font-bold mb-6 text-sm ${result.isWorthIt ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                         {result.isWorthIt 
                           ? `üßÉ Worth the squeeze! Pays off in ~${(result.buildHours / (result.grossHours / result.instances)).toFixed(0)} uses.` 
                           : "üçã Sour! You spent more time building than saving."}
                       </div>

                       {/* The Math Breakdown */}
                       <div className="bg-gray-50 rounded-xl p-3 text-left border border-gray-100 flex justify-between items-center text-sm">
                         <div className="text-center w-1/2 border-r border-gray-200">
                            <div className="text-gray-400 text-xs uppercase font-bold">Gross Savings</div>
                            <div className="text-gray-800 font-bold text-lg">{result.grossHours} hrs</div>
                         </div>
                         <div className="text-center w-1/2">
                            <div className="text-gray-400 text-xs uppercase font-bold">Build Cost</div>
                            <div className="text-red-500 font-bold text-lg">-{result.buildHours} hrs</div>
                         </div>
                       </div>

                     </div>
                   )}
                   {isAnimating && (
                      <div className="text-center py-10">
                        <p className="text-orange-500 font-bold animate-pulse">Crunching the numbers...</p>
                      </div>
                   )}
                 </div>
               </div>
            )}
          </div>
        </div>

        {/* Footer */}
        <div className="mt-16 text-center text-gray-400 text-sm">
           <p className="flex items-center justify-center gap-2">
             <span>üçä Made for efficiency lovers</span>
           </p>
        </div>

      </div>
    </div>
  );
};

export default App;
